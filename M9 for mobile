local playerService = game:GetService("Players")
local replicatedStorage = game:GetService("ReplicatedStorage")
local userInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

-- Function to find the closest player to a position
local function findClosestPlayerToPoint(worldPosition)
    local closestPlayer = nil
    local shortestDistance = math.huge -- Start with a very large distance

    for _, player in pairs(playerService:GetPlayers()) do
        if player ~= playerService.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local playerPosition = player.Character.HumanoidRootPart.Position
            local distance = (playerPosition - worldPosition).Magnitude
            if distance < shortestDistance then
                closestPlayer = player
                shortestDistance = distance
            end
        end
    end

    return closestPlayer
end

-- Function to fire the pistol at the closest player to the tap
local function firePistol(tapPosition)
    -- Convert the tap position to a ray in 3D space
    local ray = camera:ViewportPointToRay(tapPosition.X, tapPosition.Y)
    local worldPosition = ray.Origin + ray.Direction * 100 -- Arbitrary distance along the ray

    -- Find the closest player to the world position
    local closestPlayer = findClosestPlayerToPoint(worldPosition)
    if closestPlayer and closestPlayer.Character and closestPlayer.Character:FindFirstChild("HumanoidRootPart") then
        -- Get the position of the closest player
        local targetCFrame = closestPlayer.Character.HumanoidRootPart.CFrame

        -- Create the args table with the updated CFrame
        local args = {
            [1] = targetCFrame
        }

        -- Fire the server event
        replicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("Weapons"):WaitForChild("PistolShoot"):FireServer(unpack(args))
    else
        warn("No valid player found near the tap position!")
    end
end

-- Connect the firing function to screen tap
userInputService.TouchTap:Connect(function(touchPositions)
    if #touchPositions > 0 then
        local tapPosition = touchPositions[1] -- Use the first touch position
        firePistol(tapPosition)
    end
end)
